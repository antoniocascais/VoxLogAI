<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoxLogAI - Audio Transcriber</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DOMPurify for HTML sanitization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <style>
        :root {
            --primary: #2e7d32;
            --primary-light: #60ad5e;
            --primary-dark: #005005;
            --primary-bg: #f1f8e9;
            --primary-bg-hover: #e8f5e9;
            --gray-light: #f5f5f5;
            --gray: #e0e0e0;
            --gray-dark: #757575;
            --text-dark: #333333;
            --text-light: #ffffff;
            --error: #d32f2f;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--gray-light);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .hero {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: var(--text-light);
            padding: 2.5rem 0 4rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: -2rem;
        }
        
        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .hero p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .container {
            max-width: 960px;
            margin: 0 auto 2rem;
            padding: 0 20px;
            position: relative;
            transform: translateY(-2rem);
        }
        
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
            border-top: 4px solid var(--primary);
        }
        
        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray);
        }
        
        .card-header h2 {
            color: var(--primary);
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .upload-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            background-color: var(--primary-bg);
            border: 2px dashed var(--primary-light);
            border-radius: var(--radius-sm);
            transition: var(--transition);
            text-align: center;
            cursor: pointer;
        }
        
        .upload-zone:hover {
            background-color: var(--primary-bg-hover);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .upload-text {
            margin-bottom: 1rem;
        }
        
        .upload-text h3 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .upload-text p {
            color: var(--gray-dark);
            font-size: 0.95rem;
        }
        
        .file-limit {
            font-size: 0.85rem;
            color: var(--gray-dark);
            margin-top: 0.25rem;
            font-weight: 500;
        }
        
        .format-badges {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* Tab styles */
        .tabs {
            margin-bottom: 1.5rem;
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid var(--gray);
            margin-bottom: 1.5rem;
        }
        
        .tab {
            padding: 0.8rem 1.2rem;
            font-weight: 500;
            cursor: pointer;
            color: var(--gray-dark);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }
        
        .tab-content {
            position: relative;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* YouTube styles */
        .youtube-input-container {
            padding: 2rem;
            background-color: rgba(255, 0, 0, 0.05);
            border: 2px dashed rgba(255, 0, 0, 0.3);
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .youtube-icon {
            font-size: 3rem;
            color: #FF0000;
            margin-bottom: 1rem;
        }
        
        .youtube-text {
            margin-bottom: 1.5rem;
        }
        
        .youtube-text h3 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .youtube-text p {
            color: var(--gray-dark);
            font-size: 0.95rem;
        }
        
        .youtube-input-wrapper {
            width: 100%;
            max-width: 500px;
        }
        
        .youtube-url-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--gray);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .youtube-url-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        .youtube-text p.small-text {
            font-size: 0.65em;
        }
        
        .format-badge {
            background-color: rgba(46, 125, 50, 0.1);
            color: var(--primary);
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            width: 100%;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-width: 140px;
        }
        
        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        button:disabled {
            background-color: var(--gray-dark);
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .file-info {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: white;
            border-radius: var(--radius-sm);
            padding: 0.8rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
        }
        
        .file-info i {
            color: var(--primary);
        }
        
        .status {
            margin-top: 1rem;
            font-weight: 500;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .transcript-container {
            background-color: white;
            border-radius: var(--radius);
            padding: 0;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .transcript-header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transcript-header h2 {
            font-size: 1.2rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .transcript-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .action-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
            min-width: auto;
            box-shadow: none;
        }
        
        .action-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(0);
            box-shadow: none;
        }
        
        .action-button:disabled {
            opacity: 0.5;
            background-color: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
        }
        
        .copied-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            top: -30px;
            right: 0;
            animation: fadeOut 1.5s forwards;
            pointer-events: none;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .transcript-content {
            padding: 1.5rem;
            min-height: 300px;
            line-height: 1.8;
            font-size: 1.05rem;
            white-space: pre-wrap;
            color: var(--text-dark);
            background-color: #fcfcfc;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .error {
            color: var(--error);
            margin-top: 1rem;
            background-color: rgba(211, 47, 47, 0.1);
            padding: 0.8rem;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .placeholder-text {
            color: var(--gray-dark);
            font-style: italic;
        }
        
        .options-container {
            margin-top: 1rem;
        }
        
        .toggle-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }
        
        .toggle-label {
            font-size: 0.85rem;
            color: var(--gray-dark);
            font-weight: 500;
        }
        
        .timestamp {
            background-color: rgba(46, 125, 50, 0.1);
            color: var(--primary);
            padding: 0 0.3rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        footer {
            background-color: var(--text-dark);
            color: var(--text-light);
            padding: 1.5rem;
            text-align: center;
            margin-top: auto;
        }
        
        footer p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .footer-links {
            display: flex;
            gap: 1.5rem; /* Space between icons */
            justify-content: center; /* Centers the icons horizontally */
        }

        .footer-links a {
            color: var(--text-light); /* Use light color for dark background */
            text-decoration: none;
            font-size: 1.5rem; /* Make icons a bit larger */
            opacity: 0.7; /* Slightly dimmed */
            transition: var(--transition);
        }

        .footer-links a:hover {
            opacity: 1; /* Full opacity on hover */
            transform: scale(1.1); /* Slight zoom effect */
        }
        
        @media (max-width: 768px) {
            .hero {
                padding: 1.5rem 0;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .container {
                transform: translateY(-1.5rem);
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .transcript-content {
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="hero">
        <h1>VoxLogAI</h1>
        <p>Transcribe audio files & YouTube videos with AI.</p>
    </div>
    
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-microphone-alt"></i> Audio Transcriber</h2>
            </div>
            <div class="card-body">
                <div class="tabs">
                    <div class="tab-header">
                        <div class="tab active" data-tab="upload-tab">
                            <i class="fas fa-file-audio"></i> Upload Audio
                        </div>
                        <div class="tab" data-tab="youtube-tab">
                            <i class="fab fa-youtube"></i> YouTube URL
                        </div>
                    </div>
                    
                    <div class="tab-content">
                        <div class="tab-pane active" id="upload-tab">
                            <div id="upload-zone" class="upload-zone" onclick="document.getElementById('audio-file').click()">
                                <input type="file" id="audio-file" accept="audio/wav,audio/mpeg,audio/x-aiff,.aiff,audio/aac,audio/ogg,audio/flac,.mp3,.wav,.aac,.ogg,.flac" class="hidden" />
                                
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                
                                <div class="upload-text">
                                    <h3>Upload Audio File</h3>
                                    <p>Click or drag and drop your audio file here</p>
                                    <p class="file-limit">Maximum file size: 15MB</p>
                                </div>
                                
                                <div class="format-badges">
                                    <span class="format-badge">WAV</span>
                                    <span class="format-badge">MP3</span>
                                    <span class="format-badge">AIFF</span>
                                    <span class="format-badge">AAC</span>
                                    <span class="format-badge">OGG</span>
                                    <span class="format-badge">FLAC</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane" id="youtube-tab">
                            <div class="youtube-input-container">
                                <div class="youtube-icon">
                                    <i class="fab fa-youtube"></i>
                                </div>
                                <div class="youtube-text">
                                    <h3>Transcribe from YouTube</h3>
                                    <p>Enter a YouTube video URL below</p>
                                    <p class="file-limit">Maximum audio length: ~10-15 minutes (15MB)</p>
                                    <p class="small-text">Please note that longer videos might take a while to transcribe</p>
                                </div>
                                <div class="youtube-input-wrapper">
                                    <input type="text" id="youtube-url" placeholder="https://www.youtube.com/watch?v=..." class="youtube-url-input" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="file-info" class="file-info hidden">
                    <i class="fas fa-file-audio"></i>
                    <span id="file-name"></span>
                </div>
                
                <div id="youtube-info" class="file-info hidden">
                    <i class="fab fa-youtube"></i>
                    <span id="youtube-title">YouTube URL ready for transcription</span>
                </div>
                
                <div class="options-container">
                    <label class="toggle-option">
                        <input type="checkbox" id="timestamp-toggle" checked>
                        <span class="toggle-label">Include timestamps</span>
                    </label>
                </div>
                
                <div class="buttons">
                    <button id="transcribe-button" disabled>
                        <i class="fas fa-language"></i>
                        Transcribe
                    </button>
                </div>
                
                <div id="upload-status" class="status hidden"></div>
                <div id="error-message" class="error hidden">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="error-text"></span>
                </div>
            </div>
        </div>
        
        <div class="transcript-container">
            <div class="transcript-header">
                <h2><i class="fas fa-file-alt"></i> Transcript</h2>
                <div class="transcript-actions">
                    <button id="new-button" class="action-button" title="Start new transcription">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="copy-button" class="action-button" title="Copy to clipboard" disabled>
                        <i class="fas fa-copy"></i>
                    </button>
                    <div id="transcript-status" class="hidden">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
            <div id="transcript-content" class="transcript-content">
                <span class="placeholder-text">No transcript yet. Select an audio file and click "Transcribe".</span>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Â© 2025 VoxLogAI - Privacy-focused audio transcription</p>

        <div class="footer-links">
            <a href="https://github.com/antoniocascais/VoxLogAI" target="_blank" rel="noopener noreferrer" aria-label="View source code on GitHub" title="View source code on GitHub">
                <i class="fab fa-github"></i>
            </a>
            <a href="mailto:contact.voxlogai@acascais.com" aria-label="Contact via Email" title="Contact via Email">
                <i class="fas fa-envelope"></i>
            </a>
        </div>
    </footer>
    
    <script>
        // Fallback for DOMPurify if it fails to load
        if (typeof DOMPurify === 'undefined') {
            console.warn('DOMPurify not loaded, creating fallback');
            // Simple fallback that escapes HTML
            window.DOMPurify = {
                sanitize: function(html, options) {
                    // Basic HTML escaping
                    const div = document.createElement('div');
                    div.textContent = html;
                    const escaped = div.innerHTML;
                    
                    // Only keep <br> and <span class="timestamp"> elements
                    return escaped
                        .replace(/&lt;br&gt;/g, '<br>')
                        .replace(/&lt;span class="timestamp"&gt;(.*?)&lt;\/span&gt;/g, 
                                '<span class="timestamp">$1</span>');
                }
            };
        }
        
        const audioFileInput = document.getElementById('audio-file');
        const transcribeButton = document.getElementById('transcribe-button');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const uploadStatus = document.getElementById('upload-status');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const transcriptContent = document.getElementById('transcript-content');
        const transcriptStatus = document.getElementById('transcript-status');
        
        // YouTube elements
        const youtubeUrlInput = document.getElementById('youtube-url');
        const youtubeInfo = document.getElementById('youtube-info');
        const youtubeTitle = document.getElementById('youtube-title');
        
        // Setup drag and drop
        const uploadZone = document.getElementById('upload-zone');
        const copyButton = document.getElementById('copy-button');
        const newButton = document.getElementById('new-button');
        const timestampToggle = document.getElementById('timestamp-toggle');
        
        // Tab navigation
        const tabs = document.querySelectorAll('.tab');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            uploadZone.style.backgroundColor = 'rgba(96, 173, 94, 0.2)';
            uploadZone.style.borderColor = '#2e7d32';
        }
        
        function unhighlight() {
            uploadZone.style.backgroundColor = '';
            uploadZone.style.borderColor = '';
        }
        
        uploadZone.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length) {
                audioFileInput.files = files;
                handleFileSelect({ target: { files } });
            }
        }
        
        // Handle file selection
        audioFileInput.addEventListener('change', handleFileSelect);
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file size (15MB limit)
                const MAX_FILE_SIZE = 15 * 1024 * 1024; // 15MB in bytes
                
                if (file.size > MAX_FILE_SIZE) {
                    fileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
                    fileInfo.classList.remove('hidden');
                    transcribeButton.disabled = true;
                    
                    errorText.textContent = `File too large. Maximum size is 15MB. Your file is ${formatFileSize(file.size)}.`;
                    errorMessage.classList.remove('hidden');
                    return;
                }
                
                fileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
                fileInfo.classList.remove('hidden');
                transcribeButton.disabled = false;
                
                // Reset previous state
                errorMessage.classList.add('hidden');
                transcriptContent.innerHTML = '<span class="placeholder-text">No transcript yet. Click "Transcribe" to process your audio.</span>';
                transcriptStatus.classList.add('hidden');
            }
        }
        
        // Handle transcription (combined upload and transcribe)
        transcribeButton.addEventListener('click', async function() {
            // Determine if we're using file upload or YouTube URL based on active tab
            const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
            const isYoutubeMode = activeTab === 'youtube-tab';
            
            // Reset UI state
            transcribeButton.disabled = true;
            errorMessage.classList.add('hidden');
            
            if (isYoutubeMode) {
                // YouTube URL transcription
                const youtubeUrl = youtubeUrlInput.value.trim();
                if (!youtubeUrl) return;
                
                // Prepare UI for transcription
                transcribeButton.innerHTML = '<span class="spinner"></span> Processing...';
                uploadStatus.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Fetching YouTube audio...';
                uploadStatus.classList.remove('hidden');
                
                try {
                    // Call YouTube transcription endpoint
                    const transcribeResponse = await fetch('/transcribe_youtube', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            youtube_url: youtubeUrl,
                            include_timestamps: timestampToggle.checked 
                        })
                    });
                    
                    const transcribeData = await transcribeResponse.json();
                    
                    if (transcribeResponse.ok) {
                        // Format transcript with timestamps and line breaks
                        const formattedHtml = formatTranscript(transcribeData.transcript);
                        
                        // Sanitize HTML before inserting into DOM
                        const sanitizedHtml = DOMPurify.sanitize(formattedHtml, { 
                            USE_PROFILES: { html: true }, 
                            ALLOWED_TAGS: ['br', 'span'], 
                            ALLOWED_ATTR: ['class'] 
                        });
                        
                        transcriptContent.innerHTML = sanitizedHtml;
                        uploadStatus.innerHTML = '<i class="fas fa-check-circle"></i> Transcription complete!';
                        transcribeButton.innerHTML = '<i class="fas fa-check"></i> Transcribed';
                        transcriptStatus.classList.remove('hidden');
                        copyButton.disabled = false;
                        
                        // Update YouTube title if available - sanitize title as well
                        if (transcribeData.title) {
                            youtubeTitle.textContent = transcribeData.title;
                        }
                    } else {
                        throw new Error(transcribeData.error || 'Transcription failed');
                    }
                } catch (error) {
                    uploadStatus.classList.add('hidden');
                    errorText.textContent = error.message;
                    errorMessage.classList.remove('hidden');
                    transcribeButton.innerHTML = '<i class="fas fa-language"></i> Transcribe';
                    transcribeButton.disabled = false;
                }
            } else {
                // File upload transcription
                const file = audioFileInput.files[0];
                if (!file) return;
                
                // Step 1: Upload file
                transcribeButton.innerHTML = '<span class="spinner"></span> Uploading...';
                uploadStatus.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Uploading file...';
                uploadStatus.classList.remove('hidden');
                
                const formData = new FormData();
                formData.append('audio', file);
                
                try {
                    // Step 1: Upload file
                    const uploadResponse = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    
                    if (!uploadResponse.ok) {
                        throw new Error(uploadData.error || 'Upload failed');
                    }
                    
                    const fileId = uploadData.file_id;
                    
                    // Step 2: Transcribe file
                    uploadStatus.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Transcribing audio...';
                    transcribeButton.innerHTML = '<span class="spinner"></span> Transcribing...';
                    
                    const transcribeResponse = await fetch('/transcribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            file_id: fileId,
                            include_timestamps: timestampToggle.checked 
                        })
                    });
                    
                    const transcribeData = await transcribeResponse.json();
                    
                    if (transcribeResponse.ok) {
                        // Format transcript with timestamps and line breaks
                        const formattedHtml = formatTranscript(transcribeData.transcript);
                        
                        // Sanitize HTML before inserting into DOM
                        const sanitizedHtml = DOMPurify.sanitize(formattedHtml, { 
                            USE_PROFILES: { html: true }, 
                            ALLOWED_TAGS: ['br', 'span'], 
                            ALLOWED_ATTR: ['class'] 
                        });
                        
                        transcriptContent.innerHTML = sanitizedHtml;
                        uploadStatus.innerHTML = '<i class="fas fa-check-circle"></i> Transcription complete!';
                        transcribeButton.innerHTML = '<i class="fas fa-check"></i> Transcribed';
                        transcriptStatus.classList.remove('hidden');
                        copyButton.disabled = false;
                    } else {
                        throw new Error(transcribeData.error || 'Transcription failed');
                    }
                } catch (error) {
                    uploadStatus.classList.add('hidden');
                    errorText.textContent = error.message;
                    errorMessage.classList.remove('hidden');
                    transcribeButton.innerHTML = '<i class="fas fa-language"></i> Transcribe';
                    transcribeButton.disabled = false;
                }
            }
        });
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // Format transcript with line breaks and timestamp formatting
        function formatTranscript(text) {
            let formattedText = text;
            
            // Format timestamps like [8m40s242ms - 8m51s12ms] if timestamps are enabled
            if (timestampToggle.checked) {
                formattedText = text.replace(/\[(\d+m\d+s\d+ms\s*-\s*\d+m\d+s\d+ms)\]/g, 
                                         '<span class="timestamp">[$1]</span>');
            }
            
            // Replace new lines with <br> tags
            return formattedText.replace(/\n/g, '<br>');
        }
        
        // Tab switching functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Hide all tab panes
                tabPanes.forEach(pane => pane.classList.remove('active'));
                
                // Show the corresponding tab pane
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Reset UI state when switching tabs
                resetUIState();
                
                // Enable or disable transcribe button based on active tab
                if (tabId === 'youtube-tab') {
                    transcribeButton.disabled = !youtubeUrlInput.value.trim();
                    fileInfo.classList.add('hidden');
                    if (youtubeUrlInput.value.trim()) {
                        youtubeInfo.classList.remove('hidden');
                    }
                } else {
                    transcribeButton.disabled = !audioFileInput.files.length;
                    youtubeInfo.classList.add('hidden');
                }
            });
        });
        
        // Handle YouTube URL input
        youtubeUrlInput.addEventListener('input', function() {
            const youtubeUrl = this.value.trim();
            
            // Simple YouTube URL validation
            const youtubePattern = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)[a-zA-Z0-9_-]{11}.*$/;
            const isValidUrl = youtubePattern.test(youtubeUrl);
            
            if (isValidUrl) {
                youtubeInfo.classList.remove('hidden');
                transcribeButton.disabled = false;
                errorMessage.classList.add('hidden');
            } else {
                youtubeInfo.classList.add('hidden');
                transcribeButton.disabled = !youtubeUrl;
                
                if (youtubeUrl && !isValidUrl) {
                    errorText.textContent = 'Invalid YouTube URL format. Use https://youtube.com/watch?v=... or https://youtu.be/...';
                    errorMessage.classList.remove('hidden');
                } else {
                    errorMessage.classList.add('hidden');
                }
            }
        });
        
        // Copy transcript to clipboard
        copyButton.addEventListener('click', function() {
            // Get the text content without HTML tags
            const transcriptText = transcriptContent.innerText;
            
            // Check if there's actual content to copy
            if (transcriptText && !transcriptText.includes('No transcript yet')) {
                navigator.clipboard.writeText(transcriptText).then(function() {
                    // Show copied message
                    const tooltip = document.createElement('span');
                    tooltip.className = 'copied-tooltip';
                    tooltip.textContent = 'Copied!';
                    
                    // Position the tooltip relative to the button
                    copyButton.style.position = 'relative';
                    copyButton.appendChild(tooltip);
                    
                    // Remove tooltip after animation completes
                    setTimeout(function() {
                        copyButton.removeChild(tooltip);
                    }, 1500);
                }).catch(function(err) {
                    console.error('Could not copy text: ', err);
                });
            }
        });
        
        // Handle timestamp toggle
        timestampToggle.addEventListener('change', function() {
            // If transcript already exists, reformat it
            if (transcriptContent.innerHTML && !transcriptContent.innerHTML.includes('placeholder-text')) {
                const currentText = transcriptContent.innerText;
                // On toggle change, we need to re-apply formatting to show/hide timestamps
                const formattedHtml = formatTranscript(currentText);
                
                // Sanitize HTML before inserting into DOM
                const sanitizedHtml = DOMPurify.sanitize(formattedHtml, { 
                    USE_PROFILES: { html: true }, 
                    ALLOWED_TAGS: ['br', 'span'], 
                    ALLOWED_ATTR: ['class'] 
                });
                
                transcriptContent.innerHTML = sanitizedHtml;
            }
        });
        
        // Handle new transcription button
        newButton.addEventListener('click', function() {
            // Reset form and UI state
            resetUIState();
        });
        
        // Function to reset UI to initial state
        function resetUIState() {
            // Reset file input
            audioFileInput.value = '';
            
            // Reset YouTube input
            // Don't reset youtubeUrlInput.value to preserve user input when switching tabs
            
            // Reset UI elements
            fileInfo.classList.add('hidden');
            youtubeInfo.classList.add('hidden');
            uploadStatus.classList.add('hidden');
            errorMessage.classList.add('hidden');
            transcriptStatus.classList.add('hidden');
            
            // Reset buttons
            transcribeButton.disabled = true;
            transcribeButton.innerHTML = '<i class="fas fa-language"></i> Transcribe';
            copyButton.disabled = true;
            
            // Reset transcript
            transcriptContent.innerHTML = '<span class="placeholder-text">No transcript yet. Select an audio file or enter a YouTube URL and click "Transcribe".</span>';
            
            // Check current tab and re-enable button if needed
            const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
            if (activeTab === 'youtube-tab' && youtubeUrlInput.value.trim()) {
                transcribeButton.disabled = false;
                youtubeInfo.classList.remove('hidden');
            } else if (activeTab === 'upload-tab' && audioFileInput.files.length) {
                transcribeButton.disabled = false;
                fileInfo.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
